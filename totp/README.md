# Time-based One-Time Password (TOTP) Plugin

This plugin can be used to verify time-based one-time passwords, or as a TOTP token itself.
It implements the algorithms described in RFC 6238 (TOTP).
The code is adapted from <https://github.com/remjey/luaotp/blob/v0.1-6/src/otp.lua>, and
uses a trimmed down copy of `basexx` library from <https://github.com/aiq/basexx>.

## Input Commands

The plugin accepts a JSON object as input with the following mandatory fields:

- `operation`: the operation to execute, see below for a list of operations,
- `account`: a string identifying the user associated with the TOTP object,
  e.g. an email address.

Some operations require more fields in the input as noted below.

The plugin accepts the following operations:

- `generate`: generates a new TOTP secret with default parameters and stores the
  secret HMAC key in a DSM security object named `totp/<account>` where `<account>`
  is the value specified in the input field `account`. The default parameters are:
  - Key length: 15 bytes
  - Hash algorithm: `SHA1`
  - Period: 30 seconds
  - Number of digits in passwords: 6
  The output contains a URL that can be used to generate QR codes suitable for 2FA
  apps. Note that this URL cannot be retrieved later on.

- `verify`: verifies if the input code is valid for the specified TOTP account.
  This operation expects a 6 digit code in a string field named `code` in the input.
  It returns a JSON object with one boolean field `verified`.
  Note that the security object is updated to keep track of the last code that was
  used so that the same code cannot be used repeatedly.

- `import`: imports a secret generated by an external TOTP validator, so that this
  can be used to generate TOTP codes from within DSM. For this operation, the specified
  `account` field is used as a name for the generated security object. To prevent
  confusion, we recommend prefixing the name with "client", so that the resulting
  security object is discernable from security objects used as a validator instead.
  This operation expects the following parameters, which can be extracted from a
  `otpauth://` TOTP URL or QR code:
  - `digits`: the number of digits used for generated TOTP codes. Must be either 6, 7, or 8.
  - `period`: The validity period of a TOTP code. Must be larger than 0.
  - `secret`: The base32 encoded secret itself.
  - `algorithm`: The hash algorithm used for this HMAC. Must be either `SHA1`, `SHA256`, or `SHA512`.
  It returns a JSON object with one field `account`, containing the name of the generated security object.

- `code`: generates a valid TOTP code for the current period for the specified account.
  This operation takes no special parameters, and returns a JSON object with one
  field `code`, which contains the TOTP code.

## Example Usage

Invoke the plugin with the following input:

```json
{
  "operation": "generate",
  "account": "test@example.com"
}
```

If successful, you'd see an output like this:

```json
{
  "url": "otpauth://totp/Fortanix%20DSM:test%40example.com?secret=2P5VGP4VU233YA6FXXDTGTP4&issuer=Fortanix%20DSM&period=30&digits=6&algorithm=SHA1",
  "security_object": "totp/test@example.com"
}
```

You can copy the URL and use existing tools to generate a QR code that can be scanned by any 2FA app.
For example <https://stefansundin.github.io/2fa-qr/> can be used for this purpose. Note that the URL
contains a shared secret and anyone with access to the URL or the QR code can generate valid one-time
passwords. Make sure you trust the tool you use to generate the QR code.

After registering the QR code in your favorite 2FA app, you can verify the code generated by your 2FA
app using the following input:

```json
{
  "operation": "verify",
  "account": "test@example.com",
  "code": "123456"
}
```

Replacing `123456` with the actual code of course.

If the code is correct you'd see an output like this:

```json
{
  "verified": true
}
```

You can also set up a TOTP token generator by importing it. Below we import the previously created validator,
but this time as a client.

```json
{
  "operation": "import",
  "account": "client/test@example.com",
  "digits": 6,
  "period": 30,
  "secret": "62P5VGP4VU233YA6FXXDTGTP4",
  "algorithm": "SHA1"
}
```

If successful, you should see an output like this:

```json
{
  "security_object": "totp/client/test@example.com"
}
```

Now, you can use this to generate TOTP codes:

```json
{
  "operation": "code",
  "account": "client/test@example.com"
}
```

Which should return an output like this:

```json
{
  "code": "123456"
}
```

## Security Considerations

The plugin stores one `HMAC` key per 2FA account, this key is not exportable so that the secret can only be
accessed when the account is created (through the `generate` operation). However, note that TOTP is a shared
secret scheme where the `HMAC` secret is known to both the prover and verifier parties. The verifier (in this
case the plugin) is executed inside Fortanix DSM and is protected with strong security mechanisms available
in DSM. The prover, i.e. the 2FA app, and any other tools with access to the URL or QR code on the other
hand are not protected in the same way. Care should be taken to avoid compromising the secret through such
tools.

The plugin additionally stores some metadata with the `HMAC` key to keep track of the TOTP parameters as well
as the last counter value (last timestamp divided by period). The counter is updated every time the plugin is
invoked to verify a code. Any user or application with access to the `HMAC` key can therefore find out the
timestamp of the last successful verification performed by the plugin for that account. Therefore it is
recommended to limit access to the `HMAC` key(s) used by this plugin as much as possible.
